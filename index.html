<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudNotes | 2026 éš±ç§åŠ å¯†ç­†è¨˜</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }

        .note-card {
            transition: all 0.3s ease;
        }

        .note-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            background: rgba(30, 41, 59, 0.9);
        }

        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar {
            width: 0px;
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <div id="app" class="max-w-3xl mx-auto px-6 py-12 md:py-20">
        <!-- åŠ¨æ€åŠ è½½åŒº -->
    </div>

    <!-- æ¥µç°¡è¨­ç½®å½ˆçª— -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center hidden p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»çµ±é…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">Worker
                        æœå‹™åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å“¡å¯†é‘°</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()"
                    class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()"
                    class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
            <div class="text-center pt-2">
                <a href="https://www.youtube.com/@sanshicao" target="_blank"
                    class="text-[10px] text-slate-600 hover:text-slate-400 font-bold tracking-widest uppercase">YouTube
                    @ä¸‰åæ§½</a>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let apiFromUrl = urlParams.get('api');
        const cfgFromUrl = urlParams.get('cfg');
        if (cfgFromUrl) { try { apiFromUrl = atob(cfgFromUrl); } catch (e) { } }
        const shareId = urlParams.get('share');

        let API_URL = apiFromUrl || localStorage.getItem('cf_notes_api') || "";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";

        const app = document.getElementById('app');

        // åŠ è§£å¯†é€»è¾‘
        async function getK(pw) {
            const enc = new TextEncoder();
            const hash = await crypto.subtle.digest('SHA-256', enc.encode(pw));
            return await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
        }
        async function encrypt(text, pw) {
            const enc = new TextEncoder(); const iv = crypto.getRandomValues(new Uint8Array(12)); const key = await getK(pw);
            const cipher = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(text));
            return btoa(JSON.stringify({ iv: Array.from(iv), data: Array.from(new Uint8Array(cipher)) }));
        }
        async function decrypt(json, pw) {
            try {
                const { iv, data } = JSON.parse(atob(json)); const key = await getK(pw);
                const dec = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, new Uint8Array(data));
                return new TextDecoder().decode(dec);
            } catch (e) { return null; }
        }

        function init() {
            if (shareId) renderShareView();
            else if (!API_URL) renderWelcomeView();
            else renderMainView();
        }

        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-blue-500/10 rounded-full text-5xl">ğŸ›¡ï¸</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed">æ‚¨çš„å°ˆå±¬åˆ†ä½ˆå¼åŠ å¯†ç­†è¨˜ç³»çµ±<br>è«‹å…ˆé—œè¯æ‚¨çš„ Cloudflare Worker å¾Œç«¯</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.classList.remove('max-w-3xl');
            app.classList.add('max-w-[90rem]'); // Expand container width

            app.innerHTML = `
            <div class="flex flex-col-reverse md:grid md:grid-cols-12 gap-8 h-[calc(100vh-8rem)] animate-in fade-in slide-in-from-bottom-4 duration-700">
                
                <!-- Left Column: List (Vault) -->
                <section class="md:col-span-4 lg:col-span-3 flex flex-col gap-4 min-h-0">
                    <div class="glass p-6 rounded-[2rem] flex flex-col h-full border-white/5 shadow-2xl overflow-hidden">
                        <div class="flex justify-between items-center px-2 pb-4 mb-2 border-b border-white/5 shrink-0">
                            <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault</h2>
                             <button onclick="loadList()" class="text-blue-500 text-xs font-black hover:underline uppercase transition">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                        </div>
                        <div id="notesList" class="flex-1 overflow-y-auto space-y-3 pr-1">
                            <div class="text-center py-20 text-slate-600 italic text-sm">é…ç½®æš—è™Ÿä¸¦å¡«å…¥å¯†ç¢¼å¾Œé»æ“Šåˆ·æ–°ã€‚</div>
                        </div>
                    </div>
                </section>

                <!-- Right Column: Editor & Settings -->
                <section class="md:col-span-8 lg:col-span-9 flex flex-col gap-6">
                    <header class="flex justify-between items-end px-2">
                        <div class="space-y-1">
                            <h1 class="text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">CloudNotes</h1>
                            <p class="text-[10px] uppercase tracking-[0.3em] text-blue-500 font-black">é»åˆ°é»åŠ å¯†ç­†è¨˜</p>
                        </div>
                        <button onclick="configUrl()" class="p-4 glass rounded-2xl hover:rotate-180 transition-all duration-500 text-xl shadow-lg">âš™ï¸</button>
                    </header>

                    <main class="glass p-8 rounded-[2.5rem] shadow-2xl space-y-6 border-white/5 flex-1 flex flex-col">
                        <input id="mainPw" type="password" placeholder="è¨­ç½®è§£å¯†ä¸»å¯†ç¢¼ (Passkey)" cache-measurement="1" class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono shrink-0">
                        <textarea id="noteInput" placeholder="åœ¨æ­¤è¼¸å…¥ç§äººå…§å®¹..." class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed flex-1 min-h-[200px]"></textarea>
                        <div class="grid grid-cols-2 gap-4 shrink-0">
                            <button onclick="doSave()" class="gradient-btn text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs shadow-lg shadow-blue-500/20">åŠ å¯†å­˜å…¥é›²ç«¯</button>
                            <button onclick="doAI()" class="glass text-purple-400 py-5 rounded-2xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ™ºèƒ½ç¸½çµ</button>
                        </div>
                    </main>

                    <footer class="text-center py-2 opacity-50 hover:opacity-100 transition duration-500 shrink-0">
                         <a href="https://www.youtube.com/@Jii_tw" target="_blank" class="text-[10px] text-slate-500 font-bold hover:text-blue-400 uppercase tracking-widest transition">Edit by Jii | YouTube</a>
                    </footer>
                </section>

            </div>
        `;
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] shadow-2xl text-center space-y-8 animate-in zoom-in duration-500">
                <div class="text-6xl animate-bounce">ğŸ”¥</div>
                <div class="space-y-2">
                    <h1 class="text-3xl font-black italic">é–±å¾Œå³ç„šè§£å¯†</h1>
                    <p class="text-slate-400 text-sm">è§£å¯†å¾Œæ•¸æ“šå°‡ç«‹å³å¾æœå‹™å™¨ç‰©ç†æ“¦é™¤</p>
                </div>
                <input id="sharePw" type="password" placeholder="è«‹è¼¸å…¥ 6 ä½ä»¥ä¸Šè§£å¯†å¯†ç¢¼" class="w-full bg-slate-950/50 border border-slate-800 p-5 rounded-2xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono">
                <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition">è§£å¯†ä¸¦éŠ·æ¯€</button>
                <div id="shareResult" class="mt-8 text-left p-6 bg-slate-950/50 rounded-2xl hidden whitespace-pre-wrap text-sm leading-relaxed border border-orange-500/20 ring-1 ring-orange-500/10 shadow-inner italic text-slate-300"></div>
                <div class="pt-8 border-t border-white/5">
                    <a href="https://www.youtube.com/@sanshicao" target="_blank" class="text-xs font-black uppercase tracking-widest text-red-500 hover:text-red-400 transition underline underline-offset-4">ğŸ¬ é—œæ³¨ YouTube @ä¸‰åæ§½ å­¸ç¿’æ­å»º</a>
                </div>
            </div>
        `;
        }

        /* --- åŠŸèƒ½é€»è¾‘ --- */
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() {
            localStorage.setItem('cf_notes_api', document.getElementById('setApi').value);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            location.reload();
        }

        async function doSave() {
            const text = document.getElementById('noteInput').value; const pw = document.getElementById('mainPw').value;
            if (!text || !pw) return alert("è«‹å¡«å¯«å…§å®¹å’Œå¯†ç¢¼");
            try {
                const cipher = await encrypt(text, pw);
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher })
                });
                if (res.ok) { alert("âœ… å·²å­˜å…¥å®‰å…¨åº«"); document.getElementById('noteInput').value = ""; loadList(); }
                else alert("âŒ æš—è™ŸéŒ¯èª¤");
            } catch (e) { alert("âŒ ç¶²çµ¡é€£æ¥å¤±æ•—"); }
        }

        async function loadList() {
            const pw = document.getElementById('mainPw').value; if (!pw) return alert("è«‹è¼¸å…¥å¯†ç¢¼è§£å¯†");
            const listDiv = document.getElementById('notesList');
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                const notes = await res.json(); listDiv.innerHTML = "";
                if (notes.length === 0) listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš«ç„¡æ•¸æ“š</div>';
                for (let n of notes) {
                    const clearText = await decrypt(n.content, pw) || "ğŸ”’ [åŠ å¯†æ•¸æ“š / å¯†ç¢¼ä¸åŒ¹é…]";
                    const card = document.createElement('div');
                    card.className = "note-card glass p-6 rounded-3xl space-y-4 border border-white/5 shadow-lg group";
                    card.innerHTML = `
                    <div class="flex justify-between text-[9px] font-black text-slate-500 tracking-widest uppercase italic">
                        <span>ç´¢å¼•ç·¨è™Ÿ #${n.id}</span>
                        <span>${new Date(n.created_at).toLocaleString()}</span>
                    </div>
                    <div class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap">${clearText}</div>
                    <div class="pt-4 border-t border-white/5 flex flex-wrap gap-6 items-center">
                        <button onclick="doShareCopy('${n.content}')" class="text-xs font-black text-blue-400 uppercase tracking-widest hover:text-blue-300 transition">ğŸ“¤ ç”Ÿæˆé–±å¾Œå³ç„šéˆæ¥</button>
                        <button onclick="doExport(\`${clearText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, ${n.id})" class="text-xs font-black text-emerald-500 uppercase tracking-widest hover:text-emerald-400 transition">ğŸ’¾ å°å‡ºå‚™ä»½</button>
                        <button onclick="doDelete(${n.id})" class="text-xs font-black text-rose-500 uppercase tracking-widest ml-auto opacity-40 group-hover:opacity-100 transition">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                `;
                    listDiv.appendChild(card);
                }
            } catch (e) { alert("æ‹‰å–å¤±æ•—"); }
        }

        async function doShareCopy(cipher) {
            const pid = Math.random().toString(36).substring(2, 12);
            try {
                await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher, public_id: pid, is_share: 1 })
                });
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}&cfg=${btoa(API_URL)}`;
                prompt("âœ… é–±å¾Œå³ç„šåŠ å¯†éˆæ¥å·²ç”Ÿæˆï¼š", fullUrl);
            } catch (e) { alert("åˆ†äº«å¤±æ•—"); }
        }

        function doExport(text, id) {
            const date = new Date().toISOString().split('T')[0];
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `CloudNote_${id}_${date}.txt`; a.click();
        }

        async function doDelete(id) {
            if (!confirm("ç¢ºå®šè¦ç‰©ç†æŠ¹é™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ")) return;
            await fetch(`${API_URL}/api/delete`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                body: JSON.stringify({ id: id })
            });
            loadList();
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; if (!text) return alert("ç­†è¨˜ç‚ºç©º");
            const btn = event.target; btn.innerText = "æ€è€ƒä¸­..."; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                document.getElementById('noteInput').value += `\n\n--- âœ¨ AI SUMMARY ---\n${data.summary}`;
            } finally { btn.innerText = "âœ¨ AI æ™ºèƒ½ç¸½çµ"; btn.disabled = false; }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value; const resDiv = document.getElementById('shareResult');
            try {
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) return alert("å¤±æ•ˆæˆ–å·²è¢«ç„šæ¯€");
                const data = await res.json(); const clearText = await decrypt(data.content, pw);
                if (clearText) { resDiv.innerText = clearText; resDiv.classList.remove('hidden'); document.getElementById('unlockBtn').disabled = true; document.getElementById('unlockBtn').innerText = "æ•¸æ“šå·²éŠ·æ¯€"; }
                else alert("å¯†ç¢¼éŒ¯èª¤");
            } catch (e) { alert("ç¶²çµ¡ç•°å¸¸"); }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('Service Worker Registration Failed', err));
        }

        init();
    </script>
</body>

</html>